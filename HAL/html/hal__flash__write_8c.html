<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Hardware Abstraction Layer: hal_flash_write.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>hal_flash_write.c File Reference</h1>
<p>Utility functions for writing to the MSP430 internal flash memory.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="hal_8h.html">hal.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hal__flash__write_8c.html">hal_flash_write.h</a>&quot;</code><br/>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">signed int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#a525e4c90f217571b138834a4aaae7250">getSegmentSize</a> (unsigned int segment)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">signed int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#a3222a04feefaa54b936551c295cb513c">printInformationMemorySegment</a> (unsigned int segment)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#aef3c641f2c40c85f46bf3176998cb46f">printInformationMemory</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">signed char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#a45492eac6d7557a14b20433f58ea4f39">informationMemorySegmentIsErased</a> (unsigned int segment)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">signed int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#a12de1882a51d3cb8c27f4fda9fd1c1b5">eraseInformationMemorySegment</a> (unsigned int segment)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">signed int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#a31c97596aeb2b6ea60983a8361499ffe">save</a> (unsigned int segment, unsigned int offset, char data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae952a2b728f2293e86184c5e22b6cf88"></a><!-- doxytag: member="hal_flash_write.c::printResetReason" ref="ae952a2b728f2293e86184c5e22b6cf88" args="()" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><b>printResetReason</b> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">__ramfunc signed int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#a2253b88021ba85fae9bb15c9ff69a73d">writeFlashSegment</a> (unsigned int segment, char *dataToWrite, unsigned int numBytes)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="hal__flash__write_8c.html#ad0066e8dbdccb03203819b6a338c52d1">mclk</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a616ece64fbf8efc80ef18cf3ecdfc4ba"></a><!-- doxytag: member="hal_flash_write.c::smclk" ref="a616ece64fbf8efc80ef18cf3ecdfc4ba" args="" -->
unsigned long&nbsp;</td><td class="memItemRight" valign="bottom"><b>smclk</b></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Utility functions for writing to the MSP430 internal flash memory. </p>
<p>MSP430 Flash memory is divided into program memory &amp; information memory.</p>
<p>Program Memory: Program memory must be erased in segments, but programmed in blocks. On the MSP430F2xx each segment is 512B and each block is 64B. MSP430F248 Program Flash from 0xFFFF to 0x4000 (48kB) in 512B segments, each divided into eight 64B blocks MSP430F247 Program Flash from 0xFFFF to 0x8000 (32kB) "   " MSP430F2410 Program Flash from 0xFFFF to 0x2100 (56kB) "   " Maximum address is 0xFFC0, higher than that is interrupt vectors.</p>
<p>Information Memory Information memory must be erased/programmed in segments. On the MSP430, Information Memory is from 0x10FF to 0x1000 (256B) in 64B segments Flash clock, fFTG must be from 257kHz to 476 kHz according to msp430F248 Datasheet, p69. Information Memory Segment A contains calibration data and shouldn't be touched. The state of the LOCKA bit is toggled when a 1 is written to it. Writing a 0 to LOCKA has no effect. This allows existing flash programming routines to be used unchanged.</p>
<dl class="rcs"><dt><b>Rev</b></dt><dd>708 </dd></dl>
<dl class="rcs"><dt><b>Author</b></dt><dd>dsmith </dd></dl>
<dl class="rcs"><dt><b>Date</b></dt><dd>2010-08-12 18:07:37 -0700 (Thu, 12 Aug 2010) </dd></dl>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a12de1882a51d3cb8c27f4fda9fd1c1b5"></a><!-- doxytag: member="hal_flash_write.c::eraseInformationMemorySegment" ref="a12de1882a51d3cb8c27f4fda9fd1c1b5" args="(unsigned int segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">signed int eraseInformationMemorySegment </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>segment</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Erases a segment of information memory. Does not allow erasing segment A. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>segment</em>&nbsp;</td><td>which information memory segment </td></tr>
  </table>
  </dd>
</dl>
<dl class="pre"><dt><b>Precondition:</b></dt><dd>SMCLK = 4000000 </dd></dl>

</div>
</div>
<a class="anchor" id="a525e4c90f217571b138834a4aaae7250"></a><!-- doxytag: member="hal_flash_write.c::getSegmentSize" ref="a525e4c90f217571b138834a4aaae7250" args="(unsigned int segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">signed int getSegmentSize </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>segment</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Private helper function to get the size of info mem or prog mem segments </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the size of the memory segment, or -1 if not a defined memory segment </dd></dl>

</div>
</div>
<a class="anchor" id="a45492eac6d7557a14b20433f58ea4f39"></a><!-- doxytag: member="hal_flash_write.c::informationMemorySegmentIsErased" ref="a45492eac6d7557a14b20433f58ea4f39" args="(unsigned int segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">signed char informationMemorySegmentIsErased </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>segment</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Determines if a segment of flash is erased (all 0xFF) </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>1 if it is erased, 0 if not, negative number if error </dd></dl>

</div>
</div>
<a class="anchor" id="aef3c641f2c40c85f46bf3176998cb46f"></a><!-- doxytag: member="hal_flash_write.c::printInformationMemory" ref="aef3c641f2c40c85f46bf3176998cb46f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void printInformationMemory </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Displays the contents of all four information memory segments </p>

</div>
</div>
<a class="anchor" id="a3222a04feefaa54b936551c295cb513c"></a><!-- doxytag: member="hal_flash_write.c::printInformationMemorySegment" ref="a3222a04feefaa54b936551c295cb513c" args="(unsigned int segment)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">signed int printInformationMemorySegment </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>segment</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Displays the contents of an information memory segment, with labels every 0x10 bytes </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>segment</em>&nbsp;</td><td>which information memory segment, either one of the predefined information memory segments or program memory segments </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>-1 if error, 0 if success </dd></dl>

</div>
</div>
<a class="anchor" id="a31c97596aeb2b6ea60983a8361499ffe"></a><!-- doxytag: member="hal_flash_write.c::save" ref="a31c97596aeb2b6ea60983a8361499ffe" args="(unsigned int segment, unsigned int offset, char data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">signed int save </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>segment</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Writes a single byte to information memory. </p>
<dl class="pre"><dt><b>Precondition:</b></dt><dd>this segment was erased </dd></dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 if success, else an error </dd></dl>

</div>
</div>
<a class="anchor" id="a2253b88021ba85fae9bb15c9ff69a73d"></a><!-- doxytag: member="hal_flash_write.c::writeFlashSegment" ref="a2253b88021ba85fae9bb15c9ff69a73d" args="(unsigned int segment, char *dataToWrite, unsigned int numBytes)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__ramfunc signed int writeFlashSegment </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>segment</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>dataToWrite</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>numBytes</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Writes sequential bytes to flash memory. Supports writing to info memory or program memory. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>segment</em>&nbsp;</td><td>which flash memory segment to write to. Must be a predefined info mem segment (INFO_MEM_SEGMENT_B, INFO_MEM_SEGMENT_C, or INFO_MEM_SEGMENT_D) or prog mem segment </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>dataToWrite</em>&nbsp;</td><td>the data to write to flash </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>numBytes</em>&nbsp;</td><td>the numberOfBytes to write. Must be less than segment size: 64B for info mem or 512B for prog mem. </td></tr>
  </table>
  </dd>
</dl>
<dl class="pre"><dt><b>Precondition:</b></dt><dd>the desired segment(s) were erased </dd></dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 if success; else an error code </dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>the last segment of program flash, PROGRAM_MEMORY_LIMIT, must be defined </dd>
<dd>
__ramfunc is an IAR intrinsic function. Using __ramfunc requires the following modifications for IAR 4.21. Add these in Project Options : Linker : Command Line Options. Newer versions may not need this. -Z(DATA)CODE_I=1100-20FF -QCODE_I=CODE_ID -Z(CODE)CODE_ID=4000-FFFF </dd></dl>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ad0066e8dbdccb03203819b6a338c52d1"></a><!-- doxytag: member="hal_flash_write.c::mclk" ref="ad0066e8dbdccb03203819b6a338c52d1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long <a class="el" href="hal__mdb1_8c.html#ad0066e8dbdccb03203819b6a338c52d1">mclk</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>For total code + CONST size of 29k, (as of 1/28/10) flash up to 0x5669 is in use. time for segment erase = 4819/fFTG, or about 12mSec time for block program is about 1.73mSec per Block, so total per segment is approx. 15mSec. If writing entire 30kB firmware image (60segments) then total time is ~900mSec. Total time spent programming each block must be less than 4mSec. (i.e. don't include much stuff inbetween writing bytes) </p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Aug 19 11:48:31 2010 for Hardware Abstraction Layer by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
